# ClickHouse Operator Configuration
# This file maps the existing clickstack setup to Altinity ClickHouse Operator

# Override name of the chart
nameOverride: ""
# Override the full name of the chart
fullnameOverride: ""

# -- Global configuration shared across charts
global:
  # -- Image registry to use for all images
  imageRegistry: ""
  # -- List of image pull secrets to use for pulling images from private registries
  imagePullSecrets: []
  # -- Storage class name for PVCs
  storageClassName: ""

# Altinity Operator Configuration
operator:
  # -- Whether to enable the Altinity Operator for ClickHouse
  # Set to false if operator is installed cluster-wide
  enabled: true

# ClickHouse Configuration (mapped to existing values)
clickhouse:
  # -- Number of replicas for ClickHouse
  replicasCount: 1
  
  # -- ClickHouse image configuration
  image:
    repository: clickhouse/clickhouse-server
    tag: "25.7-alpine"
    pullPolicy: Always
  
  # -- Service configuration
  service:
    type: ClusterIP
    serviceAnnotations: {}
    serviceLabels: {}
  
  # -- Load balancer service (if needed)
  lbService:
    enabled: false
  
  # -- Persistence configuration
  persistence:
    enabled: true
    size: 10Gi
    accessMode: ReadWriteOnce
    storageClass: ""
    logs:
      enabled: false
      size: 5Gi
      accessMode: ReadWriteOnce
  
  # -- Default user configuration
  defaultUser:
    password: "password"  # Should be overridden with secrets in production
    allowExternalAccess: false
    hostIP: "127.0.0.1/32"
  
  # -- Additional users configuration (mapped from existing config)
  users:
    - name: "app_user"
      hostIP: 
        - "10.0.0.0/8"
        - "172.16.0.0/12" 
        - "192.168.0.0/16"
      accessManagement: 1
      password: "password"  # Should be overridden with secrets
      grants:
        - "GRANT SHOW ON *.*"
        - "GRANT SELECT ON system.*"
        - "GRANT SELECT ON default.*"
        - "GRANT SELECT,INSERT,CREATE,SHOW ON default.*"
  
  # -- Init scripts configuration
  initScripts:
    enabled: false
    configMapName: ""
    alwaysRun: true
  
  # -- Extra configuration (S3 storage and other settings)
  extraConfig: |
    <clickhouse>
      <!-- S3 Storage Configuration -->
      <storage_configuration>
        <disks>
          <s3_disk>
            <type>s3</type>
            <endpoint>https://s3.amazonaws.com/my-metrics-bucket/</endpoint>
            <access_key_id></access_key_id>
            <secret_access_key></secret_access_key>
            <region>us-east-1</region>
          </s3_disk>
        </disks>
        <policies>
          <s3_policy>
            <volumes>
              <default_volume>
                <disk>s3_disk</disk>
              </default_volume>
            </volumes>
          </s3_policy>
        </policies>
      </storage_configuration>
      
      <!-- Default Database -->
      <default_database>metrics_ingested</default_database>
      
      <!-- Timezone -->
      <timezone>UTC</timezone>
      
      <!-- Network Configuration -->
      <networks>
        <ip>::1</ip>
        <ip>127.0.0.1</ip>
        <ip>10.0.0.0/8</ip>
        <ip>172.16.0.0/12</ip>
        <ip>192.168.0.0/16</ip>
      </networks>
      
      <!-- Performance Settings -->
      <max_memory_usage>8000000000</max_memory_usage>
      <max_threads>8</max_threads>
    </clickhouse>
  
  # -- Service account configuration (important for IRSA)
  serviceAccount:
    create: true
    annotations: {}
    name: ""
  
  # -- Pod annotations and labels
  podAnnotations: {}
  podLabels: {}
  
  # -- Resources configuration
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 1000m
      memory: 2Gi
  
  # -- Security context
  securityContext:
    fsGroup: 101
    runAsNonRoot: true
    runAsGroup: 101
    runAsUser: 101
  
  # -- Node selector and affinity
  nodeSelector: {}
  tolerations: []
  affinity: {}
  
  # -- Additional ports (for custom needs)
  extraPorts: []

# Keeper Configuration (disabled for single node)
keeper:
  enabled: false

# -- CronJob Configuration for Parquet Converter
# This will be deployed separately as the operator doesn't include CronJob support
cronjobs:
  parquetConverter:
    enabled: true
    schedule: "*/10 * * * *"
    image:
      repository: my-registry/parquet-converter
      tag: latest
      pullPolicy: Always
    env:
      SOURCE_BUCKET: "raw-metrics"
      DEST_BUCKET: "processed-metrics"
      RAW_PREFIX: "raw"
      PROCESSED_PREFIX: "processed"
      ARCHIVE_PREFIX: "archive"
      LOOKBACK_HOURS: 0.2
    resources:
      limits:
        cpu: "500m"
        memory: "1Gi"
      requests:
        cpu: "200m"
        memory: "512Mi"
    annotations: {}
    podAnnotations: {}
    securityContext: {}

# -- Scripts Configuration for migration
scripts:
  enabled: false
  files: []
  delayBetween: 2
