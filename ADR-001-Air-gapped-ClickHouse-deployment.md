# ADR-001: Air-gapped ClickHouse Deployment with S3 Storage (Control Plane)

## Status
Accepted (Refined for Control Plane)

## Context
We need to deploy the Control Plane components ("Green Box") for the Tokenization Dashboard. This includes the Product Metrics Query Service, a Cronjob for data conversion, and a Compute-only ClickHouse instance.
The deployment must be:
- Air-gapped compatible.
- Flexible and modular (Umbrella Helm Chart).
- Lightweight (avoiding unnecessary components like HyperDX or Otel from off-the-shelf charts).
- Capable of querying data stored in S3 (Parquet format) generated by the Data Plane.

## Decision

### Architecture Overview

```mermaid
graph TB
    subgraph "Control Plane (Air-gapped K8s)"
        subgraph "Umbrella Chart"
            PM[Product Metrics<br/>Query Service]
            CJ[Parquet Converter<br/>CronJob]
            CH[ClickHouse<br/>(Compute Only)]
        end
    end
    
    subgraph "Storage Layer"
        S3_RAW[S3: Raw JSON]
        S3_PQ[S3: Processed Parquet]
    end
    
    UI[Dashboard SPA] --> PM
    PM --> CH
    CH --> S3_PQ : Query (Read Only)
    CJ --> S3_RAW : Read JSON
    CJ --> S3_PQ : Write Parquet
    
    style PM fill:#bfb,stroke:#333,stroke-width:2px
    style CJ fill:#bbf,stroke:#333,stroke-width:2px
    style CH fill:#f9f,stroke:#333,stroke-width:2px
    style S3_RAW fill:#fbb,stroke:#333,stroke-width:2px
    style S3_PQ fill:#fbb,stroke:#333,stroke-width:2px
```

### Components

1. **Product Metrics Query Service**
   - Golang service.
   - Queries ClickHouse for analytics data.
   - Serves the Frontend Dashboard.

2. **Parquet Converter CronJob**
   - Periodically converts raw JSON metrics (from Data Plane) to optimized Parquet files.
   - Stores results back to S3.

3. **ClickHouse (Compute Only)**
   - Stateless ClickHouse server (StatefulSet for identity, but no local data).
   - Configured with S3 storage policies to query Parquet files directly.
   - No local storage requirement for data (only temp/cache).

### Helm Strategy: Umbrella Chart

We will use a custom Umbrella Helm Chart (`control-plane-umbrella`) to manage these three components as a single release while keeping them loosely coupled.

#### Structure
```text
control-plane-umbrella/
├── Chart.yaml
├── values.yaml
└── charts/
    ├── product-metrics/      # Golang Service
    ├── parquet-converter/    # CronJob
    └── clickhouse-compute/   # CH Server + S3 Config
```

#### 1. Image Management
```yaml
# Pre-load container images into private registry
images:
  product-metrics:
    repository: private-registry.local/product-metrics
    tag: "1.0.0"
  parquet-converter:
    repository: private-registry.local/parquet-converter
    tag: "1.0.0"
  clickhouse:
    repository: private-registry.local/clickhouse-server
    tag: "23.8"
```

#### 2. Storage Configuration
ClickHouse will be configured with `storage_configuration` to treat S3 as a disk/volume, allowing querying of external Parquet data.

```xml
<storage_configuration>
    <disks>
        <s3_disk>
            <type>s3</type>
            <endpoint>http://minio-service:9000/bucket/</endpoint>
            ...
        </s3_disk>
    </disks>
</storage_configuration>
```

## Helm Chart Deployment

### chart.yaml
```yaml
apiVersion: v2
name: control-plane-umbrella
description: Umbrella chart for Control Plane components
type: application
version: 1.0.0
dependencies:
  - name: product-metrics
    version: 0.1.0
    repository: "file://charts/product-metrics"
  - name: parquet-converter
    version: 0.1.0
    repository: "file://charts/parquet-converter"
  - name: clickhouse-compute
    version: 0.1.0
    repository: "file://charts/clickhouse-compute"
```

### Values Configuration
```yaml
global:
  region: us-east-1
  environment: airgapped

product-metrics:
  replicaCount: 2
  image:
    repository: private-repo/metrics
    tag: latest

parquet-converter:
  schedule: "*/10 * * * *"

clickhouse-compute:
  storage:
    s3:
      endpoint: "http://minio:9000"
      bucket: "metrics-data"
```

## Implementation Steps

1. **Build & Push Images**: Build Docker images for the Go service and Converter; pull official CH image. Push all to air-gapped registry.
2. **Package Charts**: Package the subcharts.
3. **Deploy Umbrella**: `helm install control-plane ./control-plane-umbrella`.
4. **Verify S3 Access**: Ensure CH can list/read from the S3 bucket.

## Consequences

### Positive
- **Modular**: Easy to upgrade individual components.
- **Lightweight**: Removes bloat from "all-in-one" observability charts.
- **Scalable**: Compute can be scaled independently of storage (S3).
- **Air-gap Ready**: Simple image dependencies, no external calls required if S3 is local (MinIO).

### Negative
- Custom chart maintenance required.
- Need to ensure S3 network connectivity from the cluster.

### Alternatives Considered
- **Open Source ClickStack**: Too heavy, includes unwanted components (HyperDX, Otel, Mongo).
- **Monolithic Chart**: Harder to manage lifecycle of individual services.
